package com;

import java.security.Principal;
import java.util.*;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.servlet.ModelAndView;

import com.model.User;
import com.model.Order;
import com.model.Review;
import com.repository.HotelRepository;
import com.repository.ItemRepository;
import com.repository.OrderRepository;
import com.repository.ReviewRepository;
import com.repository.UsersRepository;


@Controller
public class AppController 
{
@Autowired
UsersRepository usersrepository;
@Autowired
HotelRepository hotelrepository;
@Autowired
ItemRepository itemrepository;
@Autowired 
OrderRepository orderrepository;
@Autowired 
ReviewRepository reviewrepository;
//public static Map<String,String> users = new HashMap<String,String>();
//public static List <Locations> l = new ArrayList<Locations>();
//public static List <Hotels> h = new ArrayList<Hotels>();
//public static Map<String,ArrayList<Items>> menu = new HashMap<String,ArrayList<Items>>();
public  Map<String,ArrayList<OrderDetails>> order = new HashMap<String,ArrayList<OrderDetails>>();
//public Map<String,ArrayList<Invoice>> invoices = new HashMap<String,ArrayList<Invoice>>();
public Map<String,ArrayList<Rating>> randr = new HashMap<String,ArrayList<Rating>>();


public static String hotelName = new String("");
public static String username = new String("");
public static int orderid=555;
public int bill;
static // Seed Data  
{
	/*l.add(new Locations("Hitech-city"));
	l.add(new Locations("Gachibowli"));
	
	h.add(new Hotels("1","swagath","Hitech-city"));
	h.add(new Hotels("2","flechazo","Hitech-city"));
	h.add(new Hotels("3","taj","Gachibowli"));
	
	menu.put("swagath", new ArrayList<Items>());
	menu.put("flechazo", new ArrayList<Items>());
	menu.put("taj", new ArrayList<Items>());
	
	menu.get("swagath").add(new Items("biryani",100));
	menu.get("swagath").add(new Items("ice-cream",50));
	menu.get("flechazo").add(new Items("noodles",70));
	menu.get("taj").add(new Items("manchuria",90));*/
}

@RequestMapping("/login")
public String login(Principal principal)
{	if(principal!=null)
	{
	order = new HashMap<String,ArrayList<OrderDetails>>();	
	return "login";
	}
else 
	return "home"; 
}
	
@RequestMapping("/")
public String home(Model model)
{
username=CustomAuth.username.toUpperCase();
model.addAttribute("name",username);
model.addAttribute("locations", hotelrepository.findAllLocations());	
return "home"; 	
}

@RequestMapping(value="/",method=RequestMethod.POST)
public String hotels(@ModelAttribute("inp") Locations inp,Model model)
{	
	model.addAttribute("place", inp.name);
	model.addAttribute("hotels",hotelrepository.findByLocation(inp.name));
	return "hotels";	
}

@RequestMapping(value="/menu",method=RequestMethod.POST)
public String menu(@ModelAttribute("inp") Hotels inp,Model model)
{
if(inp.name!=null||inp.name!="")
hotelName=inp.name; 	
//ArrayList <Items> temp = menu.get(hotelName); 
model.addAttribute("place",hotelName);
model.addAttribute("menu",itemrepository.findByHname(hotelName));

return "menu";
}


@RequestMapping(value="/addItem",method=RequestMethod.POST)
public String menu(@ModelAttribute("inp") OrderDetails inp,Model model)
{
	//System.out.println("not added!"+inp.name+inp.quantity+inp.price);

	if(inp.quantity>0)
	{
	int flag=0;
	if(order.get(hotelName)==null)
	{	
		ArrayList<OrderDetails> al=new ArrayList<OrderDetails>();
		al.add(new OrderDetails(inp.item,inp.quantity,inp.price));
		order.put(hotelName,al);
	}
		else
	{
		for(OrderDetails x : order.get(hotelName))
			if(x.item.equals(inp.item))
			{
				x.quantity+=inp.quantity;
				System.out.println(x.item +"!");
				flag=1;
			}
	
		if(flag==0)
			{
			System.out.println("added!");
			order.get(hotelName).add(new OrderDetails(inp.item,inp.quantity,inp.price));
			}
	}
	
	}


//ArrayList <Items> temp = menu.get(hotelName); 
model.addAttribute("place",hotelName);
model.addAttribute("menu",itemrepository.findByHname(hotelName));

int totalBill=0;
ArrayList<OrderDetails> temp1 = new ArrayList<OrderDetails>();

//Set<String> keys = order.keySet();
//for(String x : keys )
	if(order.get(hotelName)!=null)
	for(OrderDetails y : order.get(hotelName))
		{
		temp1.add(new OrderDetails(y.getItem(),y.getQuantity(),y.quantity*y.getPrice()));
		totalBill+=y.quantity*y.getPrice();
		}

bill=totalBill;
model.addAttribute("cart", temp1);
model.addAttribute("totalBill",totalBill);
return "menu";
}

@RequestMapping(value="removeItem",method=RequestMethod.POST)
public String removeItem(@ModelAttribute("inp") OrderDetails inp,Model model)
{
	for(OrderDetails x : order.get(hotelName))
			if(x.getItem().equals(inp.item))
			{
				order.get(hotelName).remove(x);
				break;
			}
	//ArrayList <Items> temp = menu.get(hotelName); 
	model.addAttribute("place",hotelName);
	model.addAttribute("menu",itemrepository.findByHname(hotelName));
	
	int totalBill=0;
	ArrayList<OrderDetails> temp1 = new ArrayList<OrderDetails>();

	//Set<String> keys = order.keySet();
	//for(String x : keys )
		if(order.get(hotelName)!=null)
		for(OrderDetails y : order.get(hotelName))
			{
			temp1.add(new OrderDetails(y.getItem(),y.getQuantity(),y.quantity*y.getPrice()));
			totalBill+=y.quantity*y.getPrice();
			}

		bill=totalBill;
	model.addAttribute("cart", temp1);
	model.addAttribute("totalBill",totalBill);
	return "menu";
}

@RequestMapping(value="/checkout",method = RequestMethod.POST)
public String checkout(Model model)
{
/*if(invoices.get(username)==null)
{
ArrayList<Invoice> al = new ArrayList<Invoice>();
al.add(new Invoice(orderid++,hotelName,bill,order.get(hotelName)));
invoices.put(username, al);
}
else
invoices.get(username).add(new Invoice(orderid++,hotelName,bill,order.get(hotelName)));*/	
//order.remove("hotelName");
Random rand = new Random();
 orderid=rand.nextInt(1000);
while(orderrepository.findByOrderid(orderid).isEmpty()==false)
	orderid=rand.nextInt(1000);
System.out.println(orderid);
	for(OrderDetails x : order.get(hotelName))
{
	Order temp = new Order();
	temp.setOrderid(orderid);
	temp.setHname(hotelName);
	temp.setUname(username);
	temp.setItem(x.item);
	temp.setPrice(x.price);
	temp.setQuantity(x.getQuantity());
	temp.setTotal(bill);
	orderrepository.save(temp);	
}
return "checkout";	
}

@RequestMapping(value="/submit-rating",method=RequestMethod.POST)
public String review(@ModelAttribute("inp") Rating inp,Model model)
{
	/*Rating temp = new Rating(username,inp.rating,inp.review);
	if(randr.get(hotelName)==null)
	{
		ArrayList<Rating> temp1 = new ArrayList<Rating>();
		temp1.add(temp);
		randr.put(hotelName,temp1);
	}
	else
		randr.get(hotelName).add(temp);*/
	
	Review r = new Review();
	r.setHname(hotelName);
	r.setUname(username);
	r.setRating(inp.rating);
	r.setReview(inp.review);
	reviewrepository.save(r);
	return "thanks";
}

@RequestMapping("view-reviews")
public String viewReviews(Model model)
{
	List<Review> r = reviewrepository.findByHname(hotelName);
	model.addAttribute("name",hotelName);
	model.addAttribute("reviews",r);

	
	return "view-reviews";
}


@RequestMapping(value="/view-orders",method = RequestMethod.GET)
public String viewOrders(Model model)
{
	
	model.addAttribute("name", username);
	//model.addAttribute("invoices",invoices.get(username));
	List<Order> x = orderrepository.findByUname(username);
	List<OrderClone> temp = new ArrayList<OrderClone>();
	for(Order y : x )
		temp.add(new OrderClone(y.getOrderid(),y.getUname(),y.getHname(),y.getItem(),y.getPrice(),y.getQuantity(),y.getTotal()));
	Map<Integer,ArrayList<OrderClone>> tempmap = new HashMap<Integer,ArrayList<OrderClone>>();
	
	for(OrderClone y : temp)
	{
		if(tempmap.get(y.orderid)==null)
		{
			ArrayList<OrderClone> temp1 = new ArrayList<OrderClone>();
			temp1.add(y);
			tempmap.put(y.orderid, temp1);
		}
		else
			tempmap.get(y.orderid).add(y);
	}
	
	
	ArrayList<DisplayOrder> disp = new ArrayList<DisplayOrder>();
	Set<Integer> keys = tempmap.keySet();

	for(int i : keys)
	{
		System.out.println("id: " + i);
		
		DisplayOrder tempo=new DisplayOrder();
		tempo.orderid=i;
		tempo.items=new ArrayList<OrderClone>();
		for(OrderClone e : tempmap.get(i))
			{
			
			tempo.items.add(e);
			System.out.println(e.item);
			tempo.hname=e.hname;
			tempo.total=e.total;
			

			}
		
		
		disp.add(tempo);
	}
	 
	for(DisplayOrder r : disp)
		for(OrderClone e : r.items )
			
	
	model.addAttribute("invoices",disp);
	return "vieworder";
}


@RequestMapping(value="/register",method = RequestMethod.GET)
public ModelAndView register()
{
	return new ModelAndView("register","command",new User());
}

@RequestMapping(value="/register",method = RequestMethod.POST)
public String addUser(@ModelAttribute("inp") Users inp , Model model)
{
	User user = new User();
	user.setUname(inp.uname);
	user.setPassword(inp.password);
	System.out.println(inp.uname);
	if(usersrepository.findByUname(inp.uname).isEmpty())
	{
		if(usersrepository.save(user)!=null);
		System.out.println("added to db!");
		return "login";
	}
	else
	{
		model.addAttribute("error",  "Invalid credentials or UserName is already taken! please choose another one.");
		return "register";
	}
	
}

@RequestMapping("/login-failure")
public String loginFail()
{
return "login-failure"; 	
}




}

